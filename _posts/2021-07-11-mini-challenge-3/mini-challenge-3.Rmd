---
title: "Mini-challenge 3"
description: |
  A short description of the post.
author:
  - name: Qian Ziwei
    url: https://example.com/norajones
date: 07-11-2021
output:
  distill::distill_article:
    self_contained: false
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(fig.retina = 3,
                      echo = TRUE,
                      eval = TRUE,
                      message = FALSE,
                      warning = FALSE)
```

# 1. Overview

---

### 1.1 Background

In the country island of Kronos, the increasing noxious effects on health and farming have been related to the uncontrolled activity of GAStech, a natural gas operator, supported by corrupt government officials. On January 20th, 2014, a corporate meeting is held to celebrate the new-found fortune because of the initial public offering of the company. However, a series of rare events occur that lead to the disappearance of several employees. The Protectors of Kronos (POK), a social movement organization that has been fighting against water contamination and government corruption, is suspected in the disappearance.

As analysts, we were assigned with several tasks in order to identify risks and how they could have been mitigated more effectively.

### 1.2 Literature review


### 1.3 Objective

Using data and visual analytics to evaluate the changing levels of risk to the public and recommend actions for first responder:

* Distinguish meaningful event reports from typical chatter from junk or spam.

* Evaluate the level of the risk to the public evolves over the course of the evening. Consider the potential consequences of the situation and the number of people who could be affected.
Determine the appropriate location for first responders.

* The differences between dealing with this challenge in 2014 and dealing with it now.

### 1.4 Question 1

### 1.5 Question 2

### 1.6 Question 3

### 1.7 Question 4


---

# 2. Building the visualization

---

### 2.1 Setting up the environment/packages

First, we run this fist line of code to clear the environment and remove existing R objects(if any).

```{r}
rm(list = ls())
```

This code chunk checks if required packages are installed. If they are not installed, the next line of code will install them. The following line is then use to import the library into the current working environment.

```{r}
packages = c('readr','tidytext','data.table','lubridate','ggplot2',
             'caret','dplyr','tidyr','scales','quanteda','textdata',
             'stringr','stringi','reshape2','RColorBrewer','wordcloud',
             'forcats','igraph','ggraph','widyr','clock','knitr','tidyverse',
             'DT','hms')
for(p in packages){
  if(!require(p,character.only = TRUE)){
    install.packages(p)
  }
  library(p,character.only = TRUE)
}
```

### 2.2 Importing data and changing data type

First, use <font color = blue>*read_csv()* </font> to import the csv file. 

```{r}
read1 <- read_csv("F:/visual/assignment and project/MC3/MC3/csv-1700-1830.csv",
                  col_types = list(col_character(),col_character(),col_character(),
                                   col_character(),col_double(),col_double(),
                                   col_character()))
read2 <- read_csv("F:/visual/assignment and project/MC3/MC3/csv-1831-2000.csv",
                  col_types = list(col_character(),col_character(),col_character(),
                                   col_character(),col_double(),col_double(),
                                   col_character()))
read3 <- read_csv("F:/visual/assignment and project/MC3/MC3/csv-2001-2131.csv",
                  col_types = list(col_character(),col_character(),col_character(),
                                   col_character(),col_double(),col_double(),
                                   col_character()))
```
Using function <font color = blue>*rbind()* </font> combine these three csv files with the same format.

```{r}
df <- rbind.data.frame(read1,read2,read3)
glimpse(df)
DT::datatable(df,filter = 'top',
              extensions = 'Buttons',
              options = list(autoWidth = TRUE, columnDefs = list(list(width = '400px', targets = c(4))),
                             dom='Bfrtip',
                             buttons=c('copy', 'csv', 'excel', 'print', 'pdf'))) 
```

From the above table the <font color = red>*date(yyyyMMddHHmmss)*</font> is not in time format, so converting to date-time field. Because in the mini-challenge 3, all activities occur on the same day.Extract time(hms) data without date and transform.

```{r}
df$`date(yyyyMMddHHmmss)` <- date_time_parse(df$`date(yyyyMMddHHmmss)`,
                                 zone = "",
                                 format = "%Y%m%d %H%M%S")
df$time <- as_hms(ymd_hms((df$`date(yyyyMMddHHmmss)`)))
glimpse(df)
DT::datatable(df,filter = 'top',
              extensions = 'Buttons',
              options = list(autoWidth = TRUE, columnDefs = list(list(width = '400px', targets = c(4))),
                             dom='Bfrtip',
                             buttons=c('copy', 'csv', 'excel', 'print', 'pdf')))
```

### 2.3 Question 1

#### 2.3.1 Data processing
In question 1, extract the required data from the <font color = red>*df*</font> to make a new data frame. After reading all the data carefully, the terminology of <font color = red>*mbdata*</font> and <font color = red>*ccdata*</font> is very different, so separate the two files. Since ccdata is a police or fire department record, this dataset is labeled as a meaningful dataset.

```{r}
df1 <- subset(df, select = c("type","author","message"))
df_m <- subset(df1, type == "mbdata")
df_cc <- subset(df1,type == "ccdata")
df_cc$condition <- "meaningful"
DT::datatable(df_cc,filter = 'top',
              extensions = 'Buttons',
              options = list(autoWidth = TRUE, columnDefs = list(list(width = '400px', targets = c(4))),
                             dom='Bfrtip',
                             buttons=c('copy', 'csv', 'excel', 'print', 'pdf')))
```

##### 2.3.1.1 Junk message

<font color = red>*JUNk definition*</font>: After reading all the data carefully, I have selected the following types of data.

* Authors like "KronosQuoth" will post content related to the three types of activities(rally, fire to collapsed, accident to gunshot) in this challenge, but cannot or rarely provide important information such as location. The content is mostly emotional and cathartic.

* Content that includes the term "#Grammar" is mostly unrelated to important events in mini-challenge 3.

* Content containing "RT" is a forwarding of other people's messages, providing the same information repeatedly. And, the number of "RT" message is very large.

```{r}
junk <- df_m %>%
  filter(str_detect(author,"KronosQuoth|Clevvah4Eva|footfingers|truccotrucco|
                  choconibbs|trollingsnark|blueSunshine|truthforcadau|whiteprotein|
                  FriendsOfKronos|junkman377|junkman995|redisrad|roger_roger|
                  cheapgoods998|rockinHW|panopticon|dels4realz|eazymoney|cleaningFish")|
           str_detect(message,"#Grammar|RT"))
```


##### 2.3.1.2 Meaningful message

<font color = red>*Meaningful definition*</font>: After reading all the data carefully, I have selected the following types of data.

* Information released by authors who are more official or authoritative. Author like "POK","AbilaPoliceDepartment".

* Information released by authors are witnesses to events and publishes information that provides important information. Authors like "magaMan","Sara_Nespola".

* Content that includes terms like "fire","rally" is mostly related to the important events in mini-challenge 3.

```{r}
meaningful <- df_m %>%
  filter(str_detect(author,"POK|AbilaPost|CentralBulletin|ourcountryyourrights|
  MindOfKronos|Viktor-E|maha_Homeland,anaregents|wordWatcher|InternationalNews|
  HomelandIlluminations|NewsOnlineToday|AbilaPoliceDepartment|KronosStar|magaMan|
  Sara_Nespola|protoGuy|SiaradSea|AbilaFireDept")|
           str_detect(message,"POK Rally|@POK|Abila City Park|POK rally|Sylvia Marek|
                      #POKrally|#POK|#POKRally|#porkrally|terrorists|#KronosStar|
                      #Ailbapost|#IntNews|@AlibaPost|#CentralBulletin|Marek|violence|
                      @ourcountryyourrights|#POKlove|Sylvia|Di Stefan|@MindOfKronos|
                      @Viktor-E|@InternationalNews|Lucio|Death|Audrey McConnel Newman|
                      @Officia1AbilaPost|#POKRallyinthepark|#POKpeace|#terror|cops|cop|
                      Jakab|@anaregents|@maha_homeland|Anarchist|#POKRallyinthepark|kidnapping|
                      crime|#terrorists|#APD|APD|Parla St|Egeou St|Alm St|Sanjorge|
                      crackdown|River Soldies|leaving|Human Trafficking rally|kidnap|
                      missing|#SavePeople|Joni Mitchell|Newman|murder|Elian|fire|
                      Achilleos|AFD|burn(delet writinLazy)|Fire Departmentsmoke|
                      bonfire, Dancing Dolphin apartment, @HomelandIlluminations|
                      fire trucks|#HELPME|ambulance|#dancingdolfinfire|occupants|
                      #DancingDolphinsFire|@dancingdolphin|#dancingdolphinfire|floor|
                      floors|fireman|firefighters|firefighter|PD|Paramedics|
                      smoke inhalation|injuries|scene|precaution fire officials|
                      evacuated|evacuate|evacuations|evacuation|evacuating|rescued|
                      out of control|AFD|under control|trapped|collapsed|blaze|
                      escalated|traffic|car hit|Souliou|black van|driver|bicyclist|
                      Schaber|#jerkdrivers|hit|injured|L829|run incident|hit and run|
                      bike|wheels|accident|biker|in pursuit|Henri|gelatogalore|
                      gelato|explosion??|gun|shots|gunshot|shot|Gunfire|gun fire|
                      shooting|shooter|chouting|killed|dead|gunman|hostages|
                      in danger|hurt|hostage|Ithakis and Alexandrias|kill|SWAT|
                      swat|standoff|negotiating|negotiator|negoitations|Carly|
                      yelling|screaming|chasing|dude|stand-off|standoff|stand off|
                      ends|caught|over|end|ended|rescued"))
```

##### 2.3.1.3 Meaningless message

<font color = red>*Meaningless definition*</font>: After reading all the data carefully, I have selected the following types of data.

* Content that includes terms like "fire","rally" which is related to the events but is used to express emotions and can not provide important information.

* Content that is unrelated to the events, but has their own objectives like sharing the information of shops.

This group is obtained by subtracting other groups from the <font color = red>*df_m*</font> through <font color = blue>*anti_join()*</font> function.

```{r}
meaningful <- dplyr::anti_join(meaningful,junk,by = c("type", "author", "message"))

combinedata <- rbind.data.frame(meaningful, junk)

meaningless <- dplyr::anti_join(df_m,combinedata,by = c("type", "author", "message"))
```

##### 2.3.1.4 Combining meaningful,meaninfless and junk message

Combine meaningful,meaningless and junk data and add a new label column.

```{r}
junk$condition <- "junk"
meaningful$condition <- "meaningful"
meaningless$condition <- "meaningless"

finalq1 <- rbind.data.frame(meaningful,junk, meaningless)
DT::datatable(finalq1,filter = 'top',
              extensions = 'Buttons',
              options = list(autoWidth = TRUE, columnDefs = list(list(width = '400px', targets = c(4))),
                             dom='Bfrtip',
                             buttons=c('copy', 'csv', 'excel', 'print', 'pdf')))
```

##### 2.3.1.5 Cleaning the dataset before token

Use <font color = blue>*stringr package*</font> to remove punctuation, @, #, < and Chinese characters from messages. The messages in <font color = red>*ccdata*</font> are very clean and do not require special handling.

```{r}
finalq1$message <- str_replace_all(finalq1$message,'[[:punct:]]+', "")

finalq1$message <- str_replace_all(finalq1$message,fixed("@"),"")

finalq1$message <- str_replace_all(finalq1$message,fixed("#"),"")

finalq1$message <- str_replace_all(finalq1$message,fixed("<"),"")

finalq1$message <- str_replace_all(finalq1$message,"[\u4e00-\u9fa5]+", "")
```

The messages in the table below is clean.
```{r}
DT::datatable(finalq1,filter = 'top',
              extensions = 'Buttons',
              options = list(autoWidth = TRUE, columnDefs = list(list(width = '400px', targets = c(4))),
                             dom='Bfrtip',
                             buttons=c('copy', 'csv', 'excel', 'print', 'pdf')))
```


##### 2.3.1.6 Token the data and custom stop-words.

```{r}
tidy_m <- finalq1 %>%
  unnest_tokens(word, message)%>%
  count(condition,word,sort = TRUE)

data(stop_words)
tidy_m <- tidy_m %>%
  anti_join(stop_words)

my_stopwords <- tibble(word = c(as.character(1:10),
                                "zawahiri","yikes","yehu","yeah",
                                "yay","ya","xx3942","wuz","wow",
                                "dr"))
tidy_m <- tidy_m %>%
  anti_join(my_stopwords)

tidy_cc <- df_cc %>%
  unnest_tokens(word,message) %>%
  count(word, sort = TRUE)

DT::datatable(tidy_m,filter = 'top',
              extensions = 'Buttons',
              options = list(autoWidth = FALSE, columnDefs = list(list(width = '60px', targets = c(0:3))),
                             dom='Bfrtip',
                             buttons=c('copy', 'csv', 'excel', 'print', 'pdf')))

DT::datatable(tidy_cc,filter = 'top',
              extensions = 'Buttons',
              options = list(autoWidth = FALSE, columnDefs = list(list(width = '60px', targets = c(0:2))),
                             dom='Bfrtip',
                             buttons=c('copy', 'csv', 'excel', 'print', 'pdf')))
```

##### 2.3.2 Simple EDA

The graph below is the word number distribution of junk,meaningful and meaningless group. The junk message has high repetition rate of words.

```{r}
ggplot(tidy_m,aes(n,fill = condition))+
  geom_histogram(show.legend = FALSE)+
  xlim(0,100)+
  facet_wrap(~condition, ncol = 2,scales = "free_y")
```

The graph below is the top 15 word(n) of junk,meaningful and meaningless group.

* Junk group

    * Most of them are words related to POK Rally, used to vent feelings or words related to success. There are also statements against the government and police. Words like "success","life","police".
    
    * There are also obvious spam features such as rt and grammar. These message number is very large and do not provide useful information.
    
* Meaningful group 

    * Words can provide information about the important people of the events. Words like "viktore".

    * Words can provide information on the important processes of the events. Words like "standoff".
    
    * Words can provide information on the important locations of the events. words like "dolphin","dancing".
    
```{r}
tidy_m %>%
  group_by(condition) %>%
  slice_max(n, n= 15) %>%
  ungroup() %>%
  ggplot(aes(x = n,
             y= word,
             fill = condition))+
  geom_col(show.legend = FALSE)+
  facet_wrap(~ condition, ncol = 2,scales = "free")

tidy_cc %>%
  slice_max(n,n = 15) %>%
  ggplot(aes(x = n,
                   y= word,
                   fill = "lightblue"))+
  geom_col(show.legend = FALSE)
```

